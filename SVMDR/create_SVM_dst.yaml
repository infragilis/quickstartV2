#-----------------------------------------------------------------------------
#Name        : createSVMdr.yaml
#Email       : boonstra@netapp.com
#Created     : 2021
#Description : This playbook creates an SVM on the destination cluster
#Dependencies: netapp-lib,netapp collections
#Link        : n/a
#Disclaimer  : THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR
#            : IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
#            : WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
#            : PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
#            : ANYDIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
#            : DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
#            : GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
#            : INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#            : WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
#            : NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
#            : THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-----------------------------------------------------------------------------
---
- hosts: localhost
  name: ONTAP
  gather_facts: false
  collections:
    - netapp.ontap
  vars_files:
   ../vars.yaml
  vars:
    login: &login
      hostname: "{{ src_cluster }}"
      username: "{{ netapp_username }}"
      password: "{{ netapp_password }}"
      https: true
      validate_certs: false
  tasks:
  - name: Create DR SVM
    na_ontap_svm:
      state: present
      name: "{{ dst_svm }}"
      subtype: "dp_destination"
      hostname: "{{ dst_cluster }}"
      username: "{{ netapp_username }}"
      password: "{{ netapp_password }}"
      https: true
      validate_certs: false

  - name: Create vserver Peer
    na_ontap_vserver_peer:
      state: present
      peer_vserver: "{{ src_svm }}"
      peer_cluster: "{{ src_cluster_name }}"
      dest_hostname: "{{ src_cluster }}"
      vserver: "{{ dst_svm }}"
      applications: snapmirror
      hostname: "{{ dst_cluster }}"
      username: "{{ netapp_username }}"
      password: "{{ netapp_password }}"
      https: true
      validate_certs: false


  - name: Create vserver SnapMirror DR
    na_ontap_snapmirror:
      state: present
      source_vserver: "{{ src_svm }}"
      destination_vserver: "{{ dst_svm }}"
      identity_preserve: "{{ identity_preserve }}"
      schedule: "5min"
      policy: "{{ DRpolicy }}"
      hostname: "{{ dst_cluster }}"
      username: "{{ netapp_username }}"
      password: "{{ netapp_password }}"
      https: true
      validate_certs: false

  - name: waiting for svm-dr status {{ dst_cluster }} / {{ dst_svm }} to change to Snapmirrored
    na_ontap_command:
      hostname: "{{ dst_cluster }}"
      username: "{{ netapp_username }}"
      password: "{{ netapp_password }}"
      https: true
      validate_certs: false
      command: ['snapmirror show -destination-path {{ dst_svm }}: -fields state']
      return_dict: true
    register: svmdrstatus
    until: svmdrstatus.msg.stdout.find("Snapmirrored") != -1
    retries: 12
    delay: 30

  - name: return svm-dr status
    debug:
       msg : "{{ svmdrstatus.msg.stdout_lines[2].split()[2] }}"


